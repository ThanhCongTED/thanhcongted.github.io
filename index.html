<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·∫•u H√¨nh Th√¥ng Tin Kh√°ch H√†ng</title>
    <style>
        :root {
            --primary: #3498db;
            --primary-dark: #2980b9;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
            --gray: #95a5a6;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        h1 {
            color: var(--dark);
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: var(--gray);
            font-size: 16px;
        }
        
        .notification {
            padding: 12px 15px;
            border-radius: 8px;
            margin: 15px 0;
            display: none;
            font-weight: 500;
        }
        
        .notification.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid var(--success);
        }
        
        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid var(--danger);
        }
        
        .notification.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid var(--warning);
        }
        
        .form-section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 18px;
            color: var(--dark);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px dashed #ddd;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            flex: 1;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .period-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .period-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .period-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }
        
        .period-btn:hover:not(.active) {
            border-color: var(--primary);
            background: #e7f3ff;
        }
        
        .price-display {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin: 15px 0;
            padding: 10px;
            background: #e7f3ff;
            border-radius: 8px;
        }
        
        .bank-info {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid var(--primary);
        }
        
        .bank-info h3 {
            color: var(--dark);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .bank-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .bank-item {
            margin-bottom: 8px;
        }
        
        .bank-label {
            font-weight: 600;
            color: var(--dark);
        }
        
        .bank-value {
            color: #2c3e50;
        }
        
        .qr-section {
            text-align: center;
            margin: 30px 0;
            padding: 25px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 1px dashed #ddd;
        }
        
        .qr-container {
            display: inline-block;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        #qrcode {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 200px;
        }
        
        .qr-message {
            margin-top: 15px;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .qr-content {
            font-weight: 600;
            color: var(--primary);
            background: #e7f3ff;
            padding: 5px 10px;
            border-radius: 5px;
            display: inline-block;
            margin-top: 5px;
        }
        
        .instruction {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid var(--warning);
            font-size: 14px;
            line-height: 1.5;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
            color: var(--gray);
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .bank-details {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .period-selector {
                flex-direction: column;
            }
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .qr-placeholder {
            width: 200px;
            height: 200px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>C·∫•u H√¨nh Th√¥ng Tin Kh√°ch H√†ng</h1>
            <p class="subtitle">Nh·∫≠p th√¥ng tin kh√°ch h√†ng v√† t·∫°o m√£ QR thanh to√°n</p>
        </header>
        
        <div id="notification" class="notification"></div>
        
        <div class="form-section">
            <h2 class="section-title">Th√¥ng Tin Kh√°ch H√†ng</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="iduser">ID Kh√°ch H√†ng:<em>(Ghi theo h√≥a ƒë∆°n c·ªßa b·∫°n)</em></label>
                    <input type="text" id="iduser" placeholder="VD: TP123456789">
                </div>
                
                <div class="form-group">
                    <label for="phoneuser">S·ªë ƒêi·ªán Tho·∫°i Kh√°ch H√†ng:</label>
                    <input type="text" id="phoneuser" placeholder="VD: 0915898345">
                </div>
                
                <div class="form-group">
                    <label for="phonename">S·ªë ƒêi·ªán Tho·∫°i Ng∆∞·ªùi Ghi Ch·ªâ S·ªë N∆∞·ªõc:</label>
                    <input type="text" id="phonename" placeholder="VD: 0925898345">
                </div>
                
                <div class="form-group">
                    <label for="checkDate">Ng√†y Ch·ªët ƒê·ªìng H·ªì:</label>
                    <select id="checkDate">
                        <option value="1">Ng√†y 1</option>
                        <option value="2">Ng√†y 2</option>
                        <option value="3">Ng√†y 3</option>
                        <option value="4">Ng√†y 4</option>
                        <option value="5">Ng√†y 5</option>
                        <option value="6">Ng√†y 6</option>
                        <option value="7">Ng√†y 7</option>
                        <option value="8">Ng√†y 8</option>
                        <option value="9">Ng√†y 9</option>
                        <option value="10">Ng√†y 10</option>
                        <option value="11">Ng√†y 11</option>
                        <option value="12">Ng√†y 12</option>
                        <option value="13">Ng√†y 13</option>
                        <option value="14">Ng√†y 14</option>
                        <option value="15">Ng√†y 15</option>
                        <option value="16">Ng√†y 16</option>
                        <option value="17">Ng√†y 17</option>
                        <option value="18">Ng√†y 18</option>
                        <option value="19">Ng√†y 19</option>
                        <option value="20">Ng√†y 20</option>
                        <option value="21">Ng√†y 21</option>
                        <option value="22">Ng√†y 22</option>
                        <option value="23">Ng√†y 23</option>
                        <option value="24">Ng√†y 24</option>
                        <option value="25">Ng√†y 25</option>
                        <option value="26">Ng√†y 26</option>
                        <option value="27">Ng√†y 27</option>
                        <option value="28">Ng√†y 28</option>
                        <option value="29">Ng√†y 29</option>
                        <option value="30">Ng√†y 30</option>
                        <option value="31">Ng√†y 31</option>
                    </select>
                </div>
                
                <div class="form-group full-width">
                    <label>Ti·ªÅn Thanh To√°n: <span class="price-display" id="priceDisplay">- VND</span></label>
                    <div class="period-selector">
                        <div class="period-btn active" data-period="1">Mua 6 Th√°ng</div>
                        <div class="period-btn" data-period="2">Mua 1 NƒÉm</div>
                        <div class="period-btn" data-period="3">Mua 2 NƒÉm</div>
                    </div>
                </div>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="saveAndGenerateQR()">
                    <span>üíæ</span> L∆∞u 
                </button>
            </div>
        </div>
        
        <div class="bank-info">
            <h3><span>üè¶</span> Th√¥ng Tin Ng√¢n H√†ng</h3>
            <div class="bank-details">
                <div class="bank-item">
                    <span class="bank-label">Ng√¢n h√†ng:</span>
                    <span class="bank-value">MBBank</span>
                </div>
                <div class="bank-item">
                    <span class="bank-label">S·ªë t√†i kho·∫£n:</span>
                    <span class="bank-value">VQRQAFEUO7939 </span>
                </div>
                <div class="bank-item">
                    <span class="bank-label">Ch·ªß t√†i kho·∫£n:</span>
                    <span class="bank-value">V≈© VƒÉn C√¥ng</span>
                </div>
                <div class="bank-item">
                    <span class="bank-label">N·ªôi dung CK:</span>
                    <span class="bank-value" id="contentDisplay">-</span>
                </div>
                <div class="bank-item full-width">
                    <span class="bank-label">S·ªë ti·ªÅn:</span>
                    <span class="bank-value" id="amountDisplay">-</span>
                </div>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>ƒêang t·∫°o m√£ QR...</p>
        </div>
        
        <div class="qr-section">
            <h3><span>üì±</span> M√£ QR Thanh To√°n</h3>
            <div class="qr-container">
                <div id="qrcode">
                    <div class="qr-placeholder">
                        H√£y qu√©t m√£ QR ƒë·ªÉ thanh to√°n
                    </div>
                </div>
            </div>
        
            <div class="instruction">
                <strong>Ch√∫ √ù:</strong> Sau khi chuy·ªÉn kho·∫£n th√†nh c√¥ng b·∫°n ƒë·ª£i 5 ph√∫t h·ªá th·ªëng t·ª± c·∫≠p nh·∫≠t. 
                Sau ƒë√≥ b·∫°n c·∫ßn kh·ªüi ƒë·ªông l·∫°i thi·∫øt b·ªã. M·ªçi th·∫Øc m·∫Øc vui l√≤ng li√™n h·ªá: 0915898345
            </div>
        </div>
        
        <footer>
            <p>¬© 2023 - H·ªá th·ªëng qu·∫£n l√Ω kh√°ch h√†ng. <a href="https://thanhcongted.com" target="_blank">Thanhcongted.com</a></p>
        </footer>
    </div>

    <script>
        // Th√¥ng tin ng√¢n h√†ng c·ªë ƒë·ªãnh
        const BANK_ACCOUNT = "VQRQAFEUO7939";
        const BANK_NAME = "V≈© VƒÉn C√¥ng";
        const BANK_CODE = "MB";
        
        // Bi·∫øn ƒë·ªÉ l∆∞u URL QR code hi·ªán t·∫°i
        let currentQRUrl = '';
        let selectedPeriod = 1;
        let selectedPrice = 0;
        let selectedCheckDate = "1";

        // Kh·ªüi t·∫°o khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            loadCustomerData();
            setupPeriodSelector();
            setupCheckDateListener();
        });

        // H√†m l·∫•y d·ªØ li·ªáu kh√°ch h√†ng t·ª´ backend
        async function loadCustomerData() {
            try {
                const response = await fetch('/get-customer-data');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();
                
                // C·∫≠p nh·∫≠t form v·ªõi d·ªØ li·ªáu t·ª´ backend
                document.getElementById('iduser').value = data.iduser || 'TP123456789';
                document.getElementById('phoneuser').value = data.phoneuser || '0915898345';
                document.getElementById('phonename').value = data.phonename || '0925898345';
                document.getElementById('checkDate').value = data.checkDate || '1';
                selectedCheckDate = data.checkDate || '1';
                
                // ƒê·ªçc gi√° tr·ªã period t·ª´ file v√† c·∫≠p nh·∫≠t giao di·ªán
                if (data.period1 && data.period2 && data.period3) {
                    updatePeriodPrices(data.period1, data.period2, data.period3);
                    
                    // ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh t·ª´ period1
                    selectedPrice = parseInt(data.period1);
                    
                    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã gi√°
                    document.getElementById('priceDisplay').textContent = formatCurrency(selectedPrice) + ' VND' ;
                    document.getElementById('amountDisplay').textContent = formatCurrency(selectedPrice) + ' VND';
                } else {
                    showNotification('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y gi√° tr·ªã period trong file', 'warning');
                }
                
                // T·∫°o QR code sau khi load d·ªØ li·ªáu
                generateQRCode();
                
            } catch (error) {
                console.error('Error loading customer data:', error);
                showNotification('‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu t·ª´ h·ªá th·ªëng', 'warning');
            }
        }

        // H√†m c·∫≠p nh·∫≠t gi√° tr·ªã cho c√°c n√∫t period
        function updatePeriodPrices(period1, period2, period3) {
            const periodButtons = document.querySelectorAll('.period-btn');
            periodButtons.forEach(button => {
                const period = button.getAttribute('data-period');
                let price = 0;
                
                if (period === '1') price = parseInt(period1);
                else if (period === '2') price = parseInt(period2);
                else if (period === '3') price = parseInt(period3);
                
                button.setAttribute('data-price', price);
                
                // C·∫≠p nh·∫≠t text hi·ªÉn th·ªã
                //button.textContent = `${period} NƒÉm (${formatCurrency(price)} VND)`;
            });
        }

        // H√†m l∆∞u d·ªØ li·ªáu l√™n backend - L∆∞u 4 tr∆∞·ªùng: iduser, phoneuser, phonename, checkDate
        async function saveCustomerData() {
            const iduser = document.getElementById('iduser').value;
            const phoneuser = document.getElementById('phoneuser').value;
            const phonename = document.getElementById('phonename').value;
            const checkDate = document.getElementById('checkDate').value;
            
            if (!iduser) {
                showNotification('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ID kh√°ch h√†ng tr∆∞·ªõc!', 'warning');
                return false;
            }
            
            try {
                // T·∫°o URL v·ªõi c√°c tham s·ªë - g·ª≠i 4 tr∆∞·ªùng c·∫ßn l∆∞u
                const params = new URLSearchParams({
                    iduser: iduser,
                    phoneuser: phoneuser,
                    phonename: phonename,
                    checkDate: checkDate
                });
                
                const response = await fetch(`/save-config?${params}`);
                const result = await response.json();
                
                if (result.success) {
                    showNotification('‚úÖ ƒê√£ l∆∞u th√¥ng tin th√†nh c√¥ng!');
                    return true;
                } else {
                    showNotification('‚ùå L·ªói khi l∆∞u th√¥ng tin: ' + result.message, 'error');
                    return false;
                }
            } catch (error) {
                console.error('Error saving customer data:', error);
                showNotification('‚ùå L·ªói k·∫øt n·ªëi khi l∆∞u th√¥ng tin', 'error');
                return false;
            }
        }

        function setupPeriodSelector() {
            const periodButtons = document.querySelectorAll('.period-btn');
            
            periodButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // X√≥a active class t·ª´ t·∫•t c·∫£ c√°c n√∫t
                    periodButtons.forEach(btn => btn.classList.remove('active'));
                    
                    // Th√™m active class cho n√∫t ƒë∆∞·ª£c ch·ªçn
                    this.classList.add('active');
                    
                    // C·∫≠p nh·∫≠t gi√° tr·ªã
                    selectedPeriod = parseInt(this.getAttribute('data-period'));
                    selectedPrice = parseInt(this.getAttribute('data-price'));
                    
                    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã gi√°
                    document.getElementById('priceDisplay').textContent = formatCurrency(selectedPrice) + ' VND';
                    document.getElementById('amountDisplay').textContent = formatCurrency(selectedPrice) + ' VND';
                    
                    // T·∫°o l·∫°i QR code v·ªõi s·ªë ti·ªÅn m·ªõi
                    generateQRCode();
                });
            });
        }

        function setupCheckDateListener() {
            const checkDateSelect = document.getElementById('checkDate');
            if (checkDateSelect) {
                checkDateSelect.addEventListener('change', function() {
                    selectedCheckDate = this.value;
                    generateQRCode();
                });
            }
        }

        function formatCurrency(amount) {
            return amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        async function saveAndGenerateQR() {
            const saved = await saveCustomerData();
            if (saved) {
                generateQRCode();
            }
        }

        function generateQRCode() {
            const iduser = document.getElementById('iduser').value;
            const contentDisplay = document.getElementById('contentDisplay');
            const amountDisplay = document.getElementById('amountDisplay');
            
            if (!iduser) {
                showNotification('‚ö†Ô∏è Vui l√≤ng nh·∫≠p ID kh√°ch h√†ng tr∆∞·ªõc!', 'warning');
                return;
            }
            
            if (selectedPrice === 0) {
                showNotification('‚ö†Ô∏è Ch∆∞a c√≥ gi√° tr·ªã ti·ªÅn ƒë·ªÉ t·∫°o m√£ QR', 'warning');
                return;
            }
            
            // Ki·ªÉm tra c√°c ph·∫ßn t·ª≠ c√≥ t·ªìn t·∫°i kh√¥ng
            if (!contentDisplay || !amountDisplay) {
                console.error('Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ hi·ªÉn th·ªã');
                return;
            }
            
            // T·∫°o n·ªôi dung chuy·ªÉn kho·∫£n v·ªõi ƒë·ªãnh d·∫°ng: ID_S·ªêNƒÇM
            const transferContent = `ThanhCong_${iduser}_${selectedPeriod}_TED`;
            
            // C·∫≠p nh·∫≠t n·ªôi dung hi·ªÉn th·ªã
            contentDisplay.textContent = transferContent;
            amountDisplay.textContent = formatCurrency(selectedPrice) + ' VND';
            
            // T·∫°o URL ·∫£nh QR t·ª´ SePay
            currentQRUrl = `https://qr.sepay.vn/img?acc=${BANK_ACCOUNT}&bank=${BANK_CODE}&amount=${selectedPrice}&des=${encodeURIComponent(transferContent)}`;

            // X√≥a m√£ QR c≈©
            const qrcodeElement = document.getElementById('qrcode');
            if (qrcodeElement) {
                qrcodeElement.innerHTML = '';
                
                // T·∫°o th·∫ª img v·ªõi URL t·ª´ SePay
                const img = document.createElement('img');
                img.src = currentQRUrl;
                img.alt = 'M√£ QR thanh to√°n';
                img.style.width = '200px';
                img.style.height = '200px';
                img.style.borderRadius = '8px';
                
                // Hi·ªÉn th·ªã loading
                const loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.style.display = 'block';
                }
                
                // X·ª≠ l√Ω khi ·∫£nh t·∫£i th√†nh c√¥ng
                img.onload = function() {
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                    showNotification('‚úÖ ƒê√£ t·∫°o m√£ QR th√†nh c√¥ng!');
                };
                
                // X·ª≠ l√Ω khi c√≥ l·ªói t·∫£i ·∫£nh
                img.onerror = function() {
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                    console.error('Failed to load QR image from SePay');
                    showNotification('‚ùå L·ªói khi t·∫£i m√£ QR t·ª´ SePay!', 'error');
                    qrcodeElement.innerHTML = '<div class="qr-placeholder">Kh√¥ng th·ªÉ t·∫£i m√£ QR</div>';
                };
                
                qrcodeElement.appendChild(img);
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            if (!notification) return;
            
            notification.textContent = message;
            notification.className = 'notification ' + type;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 4000);
        }

        // T·ª± ƒë·ªông t·∫°o m√£ QR khi thay ƒë·ªïi ID
        document.getElementById('iduser').addEventListener('input', function() {
            // C·∫≠p nh·∫≠t n·ªôi dung hi·ªÉn th·ªã ngay l·∫≠p t·ª©c
            const contentDisplay = document.getElementById('contentDisplay');
            
            // T·∫°o n·ªôi dung chuy·ªÉn kho·∫£n v·ªõi ƒë·ªãnh d·∫°ng: ID_S·ªêNƒÇM
            const transferContent = `${this.value}_${selectedPeriod}`;
            
            if (contentDisplay) contentDisplay.textContent = transferContent;
            
            // T·∫°o m√£ QR m·ªõi sau 1 gi√¢y (debounce)
            clearTimeout(window.qrTimeout);
            window.qrTimeout = setTimeout(generateQRCode, 1000);
        });
    </script>
</body>
</html>
